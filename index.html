<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบพิมพ์ฉลาก V2 (Admin/User)</title>
    <style>
        /* --- General Styles --- */
        body {
            font-family: sans-serif;
            margin: 0; /* Remove default margin */
            padding: 0; /* Remove default padding */
            background-color: #f4f4f4;
            display: flex;
            justify-content: center; /* Center content horizontally */
            align-items: flex-start; /* Align content to the top */
            min-height: 100vh; /* Ensure body takes full viewport height */
            padding-top: 20px; /* Add some space at the top */
            padding-bottom: 20px; /* Add space at the bottom */
        }
        .screen-container {
            width: 90%; /* Adjust width as needed */
            max-width: 900px; /* Max width for larger screens */
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        h1, h2, h3 {
            color: #333;
            margin-top: 0; /* Remove default top margin for headings */
        }
        h2 { margin-bottom: 15px; }
        h3 { margin-bottom: 10px; color: #555;}

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"],
        input[type="password"],
        input[type="file"],
        input[type="number"],
        input[type="date"], /* Added date input style */
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        button {
            background-color: #007bff; /* Primary blue */
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 10px;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button.secondary { background-color: #6c757d; } /* Gray */
        button.secondary:hover { background-color: #5a6268; }
        button.success { background-color: #28a745; } /* Green */
        button.success:hover { background-color: #218838; }
        button.danger { background-color: #dc3545; } /* Red */
        button.danger:hover { background-color: #c82333; }
        button.warning { background-color: #ffc107; color: #333;} /* Yellow */
        button.warning:hover { background-color: #e0a800; }

        /* --- Screen Visibility --- */
        #login-screen,
        #registration-screen,
        #app-screen {
             /* Screen containers already centered by body flex */
        }
        #registration-screen,
        #app-screen {
            display: none; /* Hide initially */
        }

        /* --- App Screen Specific --- */
        #admin-dashboard,
        #user-dashboard {
             display: none; /* Hide role dashboards initially */
        }
        .user-info {
            display: flex; /* Use flexbox for layout */
            justify-content: space-between; /* Space items */
            align-items: center; /* Vertically align items */
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .user-info span {
            font-weight: bold;
            color: #333;
        }

        /* --- Hideable Sections (Opacity based removed for clarity) --- */
        .workflow-section {
            display: none; /* Hide workflow sections */
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
        }
        .workflow-section.active {
             display: block; /* Show active section */
        }

        /* --- Table Styles --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px; /* Increased padding */
            text-align: left;
            vertical-align: middle; /* Align vertically */
        }
        th {
            background-color: #e9ecef; /* Lighter gray for header */
            font-weight: bold;
            color: #495057;
        }
        tbody tr:nth-child(odd) {
             background-color: #f8f9fa; /* Zebra striping */
        }
        td button { /* Style buttons inside table cells */
            padding: 5px 10px;
            font-size: 0.9rem;
            margin: 0 2px; /* Add small margin between buttons */
        }

        /* --- Specific Element Styles --- */
        #preview-area img {
            max-width: 250px; /* Increased preview size */
            max-height: 150px;
            border: 1px solid #ccc;
            margin: 5px;
            background-color: #eee; /* Placeholder background */
            display: inline-block; /* Allow multiple images side-by-side */
            vertical-align: top;
        }
         .error-message {
            color: #dc3545; /* Red */
            font-weight: bold;
            margin-top: 10px;
            display: block; /* Ensure it takes its own line */
        }
         .success-message {
             color: #28a745; /* Green */
             font-weight: bold;
             margin-top: 10px;
             display: block;
         }
        .mapping-pair {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .mapping-pair label, .mapping-pair span {
             margin-bottom: 5px; /* Add bottom margin for wrapped items */
             margin-right: 10px;
        }
        .mapping-pair select {
            flex-grow: 1; /* Allow select to take available space */
            min-width: 200px; /* Minimum width */
            margin-bottom: 0;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 0.85rem;
            font-weight: bold;
            border-radius: 4px;
            color: white;
            text-align: center;
        }
        .status-received { background-color: #6c757d; } /* Gray */
        .status-proofing { background-color: #ffc107; color: #333;} /* Yellow */
        .status-printing { background-color: #17a2b8; } /* Teal */
        .status-qc_qa { background-color: #fd7e14; } /* Orange */
        .status-ready { background-color: #28a745; } /* Green */
        .status-delivered { background-color: #007bff; } /* Blue */

    </style>
</head>
<body>

<div class="screen-container">

    <!-- ======================= Login Screen ======================= -->
    <div id="login-screen">
        <h1>เข้าสู่ระบบ</h1>
        <form id="login-form">
            <div class="section">
                <label for="username">ชื่อผู้ใช้:</label>
                <input type="text" id="username" name="username" required>

                <label for="password">รหัสผ่าน:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit">เข้าสู่ระบบ</button>
            <button type="button" id="show-register-button" class="secondary">ลงทะเบียน</button>
            <div id="login-error" class="error-message" style="display: none;"></div>
            <p style="margin-top: 15px;"><a href="#">ลืมรหัสผ่าน?</a></p>
        </form>
    </div>

    <!-- ======================= Registration Screen ======================= -->
    <div id="registration-screen" style="display: none;">
        <h1>ลงทะเบียนผู้ใช้ใหม่</h1>
        <form id="register-form">
            <div class="section">
                <label for="reg-fullname">ชื่อ-นามสกุล:</label>
                <input type="text" id="reg-fullname" required>

                <label for="reg-empid">รหัสพนักงาน:</label>
                <input type="text" id="reg-empid" required>

                <label for="reg-position">ตำแหน่งงาน:</label>
                <input type="text" id="reg-position" required>

                <label for="reg-department">แผนก:</label>
                <select id="reg-department" required>
                    <option value="" disabled selected>-- เลือกแผนก --</option>
                    <option value="prod1">Production 1</option>
                    <option value="prod2">Production 2</option>
                    <option value="prod3">Production 3</option>
                    <option value="qc">QC</option>
                    <option value="qa">QA</option>
                    <option value="other">Other</option>
                </select>

                <label for="reg-username">ชื่อผู้ใช้ที่ต้องการ:</label>
                <input type="text" id="reg-username" required>

                <label for="reg-password">รหัสผ่าน:</label>
                <input type="password" id="reg-password" required>
            </div>
            <button type="submit" class="success">ส่งคำขอลงทะเบียน</button>
            <button type="button" id="back-to-login-button" class="secondary">กลับไปหน้า Login</button>
            <div id="register-message" class="success-message" style="display: none;"></div>
             <div id="register-error" class="error-message" style="display: none;"></div>
        </form>
    </div>

    <!-- ======================= Main Application Screen (Post-Login) ======================= -->
    <div id="app-screen" style="display: none;">
        <div class="user-info">
            <span id="welcome-message">ยินดีต้อนรับ, <span id="logged-in-user"></span>!</span>
            <button id="logout-button" class="danger">ออกจากระบบ</button>
        </div>

        <!-- == Admin Dashboard == -->
        <div id="admin-dashboard">
            <h2>Admin Dashboard</h2>

            <!-- Admin Section 1: User Approval -->
            <div class="section">
                <h3><i class="fas fa-user-check"></i> อนุมัติผู้ใช้งาน</h3>
                <div id="user-approval-list">
                    <p>กำลังโหลดรายการผู้ใช้ที่รออนุมัติ...</p>
                    <!-- Table will be populated by JS -->
                     <table>
                         <thead>
                             <tr>
                                 <th>ชื่อ-นามสกุล</th>
                                 <th>รหัสพนักงาน</th>
                                 <th>ชื่อผู้ใช้</th>
                                 <th>แผนก</th>
                                 <th>การดำเนินการ</th>
                             </tr>
                         </thead>
                         <tbody id="pending-users-tbody">
                             <!-- Pending users rows go here -->
                         </tbody>
                     </table>
                </div>
                 <div id="approval-status-message" style="margin-top: 10px;"></div>
            </div>

            <!-- Admin Section 2: Template Management & Printing -->
            <div class="section">
                 <h3><i class="fas fa-file-pdf"></i> จัดการ Template และการพิมพ์</h3>

                 <!-- Step A.1: Upload PDF Template -->
                 <div id="admin-pdf-upload" class="workflow-section active"> <!-- Start active -->
                     <h4>1. อัปโหลดไฟล์ตัวอย่างฉลาก (PDF)</h4>
                     <label for="admin-pdf-file">เลือกไฟล์ PDF:</label>
                     <input type="file" id="admin-pdf-file" accept=".pdf">
                     <button id="analyze-pdf-button" disabled>วิเคราะห์และแสดงตัวอย่าง PDF</button>
                     <div id="pdf-upload-status"></div>
                </div>

                 <!-- Step A.2: Preview PDF & Analysis (Simulated) -->
                 <div id="admin-pdf-preview" class="workflow-section">
                     <h4>2. ตัวอย่างและข้อมูลที่วิเคราะห์จาก PDF (จำลอง)</h4>
                     <p><strong>ชื่อไฟล์:</strong> <span id="pdf-filename-display"></span></p>
                     <div>
                         <strong>ตัวอย่างหน้า PDF (จำลอง):</strong><br>
                         <img src="https://via.placeholder.com/400x250.png?text=Simulated+PDF+Preview" alt="Simulated PDF Preview" style="max-width:100%; border: 1px solid #ccc;">
                     </div>
                     <div style="margin-top: 15px;">
                         <strong>ช่องข้อมูลที่ตรวจพบ (จำลอง):</strong>
                         <ul id="detected-fields-list">
                             <!-- Detected fields will be added by JS -->
                             <li>ชื่อสินค้า (Product Name)</li>
                             <li>รหัส SKU (SKU)</li>
                             <li>ราคา (Price)</li>
                             <li>ข้อมูลบาร์โค้ด (Barcode Data)</li>
                         </ul>
                     </div>
                     <button id="proceed-to-mapping-button">ดำเนินการจับคู่ข้อมูล</button>
                </div>

                 <!-- Step A.3: Data Mapping -->
                 <div id="admin-mapping-section" class="workflow-section">
                    <h4>3. จับคู่ข้อมูล (สำหรับไฟล์ Excel/CSV ที่จะนำเข้า)</h4>
                    <p>กำหนดว่าข้อมูลจากไฟล์ Excel/CSV จะไปอยู่ในช่องใดของ Template ที่วิเคราะห์จาก PDF:</p>
                    <form id="admin-mapping-form">
                        <div id="admin-mapping-pairs">
                            <!-- Mapping UI will be populated by JS based on detected fields -->
                        </div>
                        <button type="submit">ยืนยันการจับคู่ Template</button>
                        <div id="admin-mapping-error" class="error-message" style="display: none;"></div>
                    </form>
                </div>

                <!-- Step A.4: (Optional) Upload Data File for Preview/Print -->
                 <div id="admin-data-upload" class="workflow-section">
                    <h4>4. (ถ้าต้องการพิมพ์) อัปโหลดไฟล์ข้อมูล (Excel/CSV)</h4>
                    <label for="admin-data-file">เลือกไฟล์ Excel/CSV:</label>
                    <input type="file" id="admin-data-file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                    <div id="admin-data-upload-status"></div>
                 </div>

                 <!-- Step A.5: Data Preview Table -->
                 <div id="admin-data-preview" class="workflow-section">
                     <h4>5. ตรวจสอบข้อมูลที่จะพิมพ์</h4>
                     <div style="max-height: 300px; overflow-y: auto;">
                         <table id="admin-data-grid">
                             <thead><tr id="admin-data-grid-header"></tr></thead>
                             <tbody id="admin-data-grid-body"></tbody>
                         </table>
                     </div>
                 </div>

                 <!-- Step A.6: Print Settings -->
                 <div id="admin-print-settings" class="workflow-section">
                     <h4>6. ตั้งค่าการพิมพ์</h4>
                     <!-- Admin might not select template here if defined by PDF? Or maybe save the mapping as a named template? -->
                     <!-- Let's assume admin saves the mapping as a template first -->
                     <label for="admin-template-name">บันทึกการจับคู่นี้เป็น Template ชื่อ:</label>
                     <input type="text" id="admin-template-name" placeholder="เช่น Template สินค้า Lot ใหม่">

                     <label for="admin-print-copies">จำนวนสำเนาต่อรายการ:</label>
                     <input type="number" id="admin-print-copies" value="1" min="1">

                     <label for="admin-printer-select">เลือกเครื่องพิมพ์:</label>
                     <select id="admin-printer-select">
                         <option value="default">เครื่องพิมพ์เริ่มต้น</option>
                         <option value="printer_hq_laser">HQ Laser Printer</option>
                         <option value="printer_prod_thermal">Production Thermal</option>
                     </select>
                     <button id="save-template-button" class="success">บันทึก Template</button>
                 </div>

                 <!-- Step A.7: Label Preview -->
                 <div id="admin-label-preview" class="workflow-section">
                     <h4>7. ตัวอย่างฉลาก (จำลอง)</h4>
                     <button id="admin-preview-button" class="secondary" disabled>แสดงตัวอย่าง</button>
                     <div id="admin-preview-area" style="margin-top: 10px;">
                          <p>อัปโหลดไฟล์ข้อมูลและกด "แสดงตัวอย่าง"</p>
                     </div>
                 </div>

                 <!-- Step A.8: Print Controls -->
                 <div id="admin-print-controls" class="workflow-section">
                     <h4>8. สั่งพิมพ์ (จำลอง)</h4>
                     <button id="admin-print-button" disabled>พิมพ์ฉลาก</button>
                     <div id="admin-print-status" style="margin-top: 15px;"></div>
                 </div>
            </div> <!-- End Template Management Section -->

        </div> <!-- End Admin Dashboard -->

        <!-- == User Dashboard == -->
        <div id="user-dashboard">
            <h2>User Dashboard</h2>

            <!-- User Section 1: Import Data & Request Labels -->
             <div class="section">
                 <h3><i class="fas fa-file-upload"></i> นำเข้าข้อมูลและขอรับฉลาก</h3>
                 <form id="user-request-form">
                     <div id="user-data-import" class="workflow-section active"> <!-- Start active -->
                         <h4>1. เลือกไฟล์ข้อมูล (Excel/CSV)</h4>
                         <label for="user-data-file">เลือกไฟล์ Excel/CSV:</label>
                         <input type="file" id="user-data-file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" required>

                         <h4 style="margin-top: 20px;">2. เลือกวันที่ต้องการรับฉลาก</h4>
                         <label for="user-delivery-date">วันที่ต้องการ:</label>
                         <input type="date" id="user-delivery-date" required>

                         <button type="submit" class="success" style="margin-top: 15px;">ส่งคำขอพิมพ์ฉลาก</button>
                         <div id="user-request-status" style="margin-top: 10px;"></div>
                    </div>
                 </form>
            </div>

            <!-- User Section 2: Check Label Status -->
             <div class="section">
                 <h3><i class="fas fa-tasks"></i> ตรวจสอบสถานะฉลาก</h3>
                 <div id="user-status-check">
                     <p>กำลังโหลดสถานะคำขอของคุณ...</p>
                     <table>
                         <thead>
                             <tr>
                                 <th>ID คำขอ</th>
                                 <th>ชื่อไฟล์</th>
                                 <th>วันที่ขอรับ</th>
                                 <th>สถานะปัจจุบัน</th>
                                 <th>การดำเนินการ</th>
                             </tr>
                         </thead>
                         <tbody id="user-jobs-tbody">
                             <!-- User job status rows go here -->
                         </tbody>
                     </table>
                 </div>
                 <div id="user-status-message" style="margin-top: 10px;"></div>
            </div>

        </div> <!-- End User Dashboard -->

    </div> <!-- End App Screen -->

</div> <!-- End Screen Container -->

    <!-- Font Awesome for Icons (Optional but nice) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
        // ======================= JavaScript (V2 - Admin/User Roles) =======================

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const registrationScreen = document.getElementById('registration-screen');
        const appScreen = document.getElementById('app-screen');

        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const showRegisterButton = document.getElementById('show-register-button');

        const registerForm = document.getElementById('register-form');
        const registerMessage = document.getElementById('register-message');
        const registerError = document.getElementById('register-error');
        const backToLoginButton = document.getElementById('back-to-login-button');

        const welcomeMessage = document.getElementById('welcome-message');
        const loggedInUserSpan = document.getElementById('logged-in-user');
        const logoutButton = document.getElementById('logout-button');

        const adminDashboard = document.getElementById('admin-dashboard');
        const userDashboard = document.getElementById('user-dashboard');

        // Admin Elements
        const pendingUsersTbody = document.getElementById('pending-users-tbody');
        const approvalStatusMessage = document.getElementById('approval-status-message');
        const adminPdfFile = document.getElementById('admin-pdf-file');
        const analyzePdfButton = document.getElementById('analyze-pdf-button');
        const pdfUploadStatus = document.getElementById('pdf-upload-status');
        const adminPdfPreviewSection = document.getElementById('admin-pdf-preview');
        const pdfFilenameDisplay = document.getElementById('pdf-filename-display');
        const detectedFieldsList = document.getElementById('detected-fields-list');
        const proceedToMappingButton = document.getElementById('proceed-to-mapping-button');
        const adminMappingSection = document.getElementById('admin-mapping-section');
        const adminMappingPairsDiv = document.getElementById('admin-mapping-pairs');
        const adminMappingForm = document.getElementById('admin-mapping-form');
        const adminMappingError = document.getElementById('admin-mapping-error');
        const adminDataUploadSection = document.getElementById('admin-data-upload');
        const adminDataFile = document.getElementById('admin-data-file');
        const adminDataUploadStatus = document.getElementById('admin-data-upload-status');
        const adminDataPreviewSection = document.getElementById('admin-data-preview');
        const adminDataGridHeader = document.getElementById('admin-data-grid-header');
        const adminDataGridBody = document.getElementById('admin-data-grid-body');
        const adminPrintSettingsSection = document.getElementById('admin-print-settings');
        const adminTemplateNameInput = document.getElementById('admin-template-name');
        const saveTemplateButton = document.getElementById('save-template-button');
        const adminLabelPreviewSection = document.getElementById('admin-label-preview');
        const adminPreviewButton = document.getElementById('admin-preview-button');
        const adminPreviewArea = document.getElementById('admin-preview-area');
        const adminPrintControlsSection = document.getElementById('admin-print-controls');
        const adminPrintButton = document.getElementById('admin-print-button');
        const adminPrintStatus = document.getElementById('admin-print-status');
        const adminPrintCopiesInput = document.getElementById('admin-print-copies');
        const adminPrinterSelect = document.getElementById('admin-printer-select');

        // User Elements
        const userRequestForm = document.getElementById('user-request-form');
        const userDataFile = document.getElementById('user-data-file');
        const userDeliveryDate = document.getElementById('user-delivery-date');
        const userRequestStatus = document.getElementById('user-request-status');
        const userJobsTbody = document.getElementById('user-jobs-tbody');
        const userStatusMessage = document.getElementById('user-status-message');


        // --- State Variables ---
        let currentUser = null; // { username: '...', role: 'admin'/'user' }
        let currentPdfInfo = null; // { filename: '...', fields: ['field1', 'field2'] }
        let currentAdminMapping = {}; // { 'ExcelCol': 'pdfFieldId', ... }
        let currentAdminData = []; // [ {pdfFieldId1: 'val', pdfFieldId2: 'val'}, ... ]

        // --- Simulated Data (Replace with Backend calls) ---
        let simulatedPendingUsers = [
            { id: 'reg001', fullname: 'สมชาย ใจดี', empid: 'E12345', username: 'somchai.j', department: 'prod1', requestedDate: new Date() },
            { id: 'reg002', fullname: 'สมหญิง จริงใจ', empid: 'E67890', username: 'somying.j', department: 'prod2', requestedDate: new Date() }
        ];
        let simulatedUserPrintJobs = [
            { id: 'job001', userId: 'UserNormal', filename: 'data_batch1.xlsx', requestDate: new Date(2023, 10, 15), deliveryDate: new Date(2023, 10, 20), status: 'received' }, // status: received, proofing, printing, qc_qa, ready, delivered
            { id: 'job002', userId: 'UserNormal', filename: 'urgent_labels.csv', requestDate: new Date(2023, 10, 16), deliveryDate: new Date(2023, 10, 18), status: 'proofing' },
            { id: 'job003', userId: 'UserNormal', filename: 'new_product_codes.xlsx', requestDate: new Date(2023, 10, 17), deliveryDate: new Date(2023, 10, 22), status: 'ready' },
            { id: 'job004', userId: 'OtherUser', filename: 'other_data.csv', requestDate: new Date(2023, 10, 17), deliveryDate: new Date(2023, 10, 21), status: 'printing' } // Belongs to another user
        ];
        const statusMap = { // For displaying status text
             received: 'รับแผน',
             proofing: 'First Prove',
             printing: 'พิมพ์เสร็จสิ้น',
             qc_qa: 'ตรวจสอบ QC/QA',
             ready: 'พร้อมส่งมอบ',
             delivered: 'รับฉลากแล้ว'
        };
         const statusClassMap = { // For badge colors
             received: 'status-received',
             proofing: 'status-proofing',
             printing: 'status-printing',
             qc_qa: 'status-qc_qa',
             ready: 'status-ready',
             delivered: 'status-delivered'
        };

        // --- Utility Functions ---
        function showScreen(screenElement) {
            loginScreen.style.display = 'none';
            registrationScreen.style.display = 'none';
            appScreen.style.display = 'none';
            if (screenElement) {
                screenElement.style.display = 'block';
            }
        }

        function showDashboard(role) {
            adminDashboard.style.display = 'none';
            userDashboard.style.display = 'none';
            if (role === 'admin') {
                adminDashboard.style.display = 'block';
                loadPendingUsers(); // Load admin specific data
                 resetAdminWorkflow(); // Reset admin workflow UI
            } else if (role === 'user') {
                userDashboard.style.display = 'block';
                loadUserPrintJobs(); // Load user specific data
                 resetUserWorkflow(); // Reset user workflow UI
            }
        }

        function showWorkflowSection(sectionElement, dashboardType) {
             let sectionsToReset = [];
             if (dashboardType === 'admin') {
                 sectionsToReset = adminDashboard.querySelectorAll('.workflow-section');
             } else if (dashboardType === 'user') {
                 sectionsToReset = userDashboard.querySelectorAll('.workflow-section');
             }
             sectionsToReset.forEach(sec => sec.classList.remove('active'));
             if (sectionElement) {
                 sectionElement.classList.add('active');
             }
         }

        // --- Reset Functions ---
         function resetAdminWorkflow() {
             // Reset PDF Upload related
             if(adminPdfFile) adminPdfFile.value = '';
             if(analyzePdfButton) analyzePdfButton.disabled = true;
             if(pdfUploadStatus) pdfUploadStatus.textContent = '';
             currentPdfInfo = null;

             // Reset Mapping related
             if(adminMappingPairsDiv) adminMappingPairsDiv.innerHTML = '';
             currentAdminMapping = {};
             if(adminMappingError) adminMappingError.style.display = 'none';
             if(adminTemplateNameInput) adminTemplateNameInput.value = '';

             // Reset Data upload / preview related
              if(adminDataFile) adminDataFile.value = '';
             if(adminDataUploadStatus) adminDataUploadStatus.textContent = '';
             currentAdminData = [];
             if(adminDataGridHeader) adminDataGridHeader.innerHTML = '';
              if(adminDataGridBody) adminDataGridBody.innerHTML = '';

             // Reset Print/Preview related
             if(adminPreviewButton) adminPreviewButton.disabled = true;
              if(adminPreviewArea) adminPreviewArea.innerHTML = '<p>อัปโหลดไฟล์ข้อมูลและกด "แสดงตัวอย่าง"</p>';
              if(adminPrintButton) adminPrintButton.disabled = true;
             if(adminPrintStatus) adminPrintStatus.textContent = '';
             if(adminPrintCopiesInput) adminPrintCopiesInput.value = '1';
              if(adminPrinterSelect) adminPrinterSelect.selectedIndex = 0;


             // Reset section visibility to initial state
             showWorkflowSection(adminDashboard.querySelector('#admin-pdf-upload'), 'admin'); // Start at PDF upload
         }

         function resetUserWorkflow() {
             if(userRequestForm) userRequestForm.reset(); // Resets file input and date
             if(userRequestStatus) userRequestStatus.textContent = '';
             if(userStatusMessage) userStatusMessage.textContent = '';
             // Status table will be reloaded by loadUserPrintJobs()
         }


        // --- Login Logic ---
        loginForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            loginError.style.display = 'none';
            loginError.textContent = '';
            console.log('Login attempt:', username);

            // --- Simulate Backend Auth ---
            let loggedInRole = null;
            if (username === 'Admin' && password === 'password1234') {
                loggedInRole = 'admin';
            } else if (username === 'UserNormal' && password === 'password1234') {
                loggedInRole = 'user';
            }
            // Add more users if needed

            if (loggedInRole) {
                currentUser = { username: username, role: loggedInRole };
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser)); // Store user object
                console.log('Login successful as:', loggedInRole);

                welcomeMessage.textContent = `ยินดีต้อนรับ, ${username}! (${loggedInRole})`;
                loggedInUserSpan.textContent = username; // Keep this for consistency if needed elsewhere

                showScreen(appScreen);
                showDashboard(loggedInRole);

            } else {
                console.log('Login failed');
                loginError.textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
                loginError.style.display = 'block';
            }
        });

        // --- Logout Logic ---
        logoutButton.addEventListener('click', () => {
            console.log('Logging out');
            currentUser = null;
            localStorage.removeItem('loggedInUser');
            loginForm.reset();
            showScreen(loginScreen);
            // No need to explicitly reset dashboards, happens on next login
        });

        // --- Registration Logic ---
        showRegisterButton.addEventListener('click', () => showScreen(registrationScreen));
        backToLoginButton.addEventListener('click', () => showScreen(loginScreen));

        registerForm.addEventListener('submit', (event) => {
            event.preventDefault();
            registerMessage.style.display = 'none';
            registerError.style.display = 'none';

            const newUser = {
                id: 'reg' + Date.now(), // Simple unique ID
                fullname: document.getElementById('reg-fullname').value,
                empid: document.getElementById('reg-empid').value,
                position: document.getElementById('reg-position').value,
                department: document.getElementById('reg-department').value,
                username: document.getElementById('reg-username').value,
                password: document.getElementById('reg-password').value, // **NEVER send plain password**
                requestedDate: new Date()
            };

            console.log('Registration submitted:', newUser);
            // --- Simulate sending to Backend ---
            // Backend should validate (e.g., username exists?), hash password, store as pending
            simulatedPendingUsers.push(newUser); // Add to our simulated list
            registerForm.reset();
            registerMessage.textContent = 'ส่งคำขอลงทะเบียนเรียบร้อยแล้ว กรุณารอการอนุมัติจาก Admin';
            registerMessage.style.display = 'block';

            // Optionally switch back to login after a delay
            setTimeout(() => showScreen(loginScreen), 3000);
        });


        // --- Admin: User Approval Logic ---
        function loadPendingUsers() {
            console.log("Loading pending users for Admin");
             pendingUsersTbody.innerHTML = ''; // Clear existing rows
            approvalStatusMessage.textContent = '';

            if (simulatedPendingUsers.length === 0) {
                pendingUsersTbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">ไม่มีผู้ใช้งานรอการอนุมัติ</td></tr>';
                return;
            }

            simulatedPendingUsers.forEach(user => {
                const row = pendingUsersTbody.insertRow();
                row.innerHTML = `
                    <td>${user.fullname}</td>
                    <td>${user.empid}</td>
                    <td>${user.username}</td>
                    <td>${user.department}</td>
                    <td>
                        <button class="success" onclick="approveUser('${user.id}')">อนุมัติ</button>
                        <button class="danger" onclick="rejectUser('${user.id}')">ปฏิเสธ</button>
                    </td>
                `;
            });
        }

        function approveUser(userId) {
             console.log(`Admin approving user: ${userId}`);
             // --- Simulate Backend Action ---
             // 1. Find user in pending list
             const userIndex = simulatedPendingUsers.findIndex(u => u.id === userId);
             if (userIndex > -1) {
                 const approvedUser = simulatedPendingUsers.splice(userIndex, 1)[0];
                 // 2. Move user to actual users table (or update status) - Not implemented here
                 // 3. In real app: Store hashed password, mark as active
                 console.log("Approved:", approvedUser);
                 approvalStatusMessage.textContent = `อนุมัติผู้ใช้ ${approvedUser.username} สำเร็จแล้ว`;
                 approvalStatusMessage.className = 'success-message'; // Use success style
                 loadPendingUsers(); // Refresh the list
             } else {
                 console.error("User not found for approval:", userId);
                  approvalStatusMessage.textContent = `เกิดข้อผิดพลาด: ไม่พบผู้ใช้ ID ${userId}`;
                 approvalStatusMessage.className = 'error-message'; // Use error style
             }
             approvalStatusMessage.style.display = 'block';
        }

        function rejectUser(userId) {
             console.log(`Admin rejecting user: ${userId}`);
              // --- Simulate Backend Action ---
             // 1. Find user in pending list
             const userIndex = simulatedPendingUsers.findIndex(u => u.id === userId);
             if (userIndex > -1) {
                 const rejectedUser = simulatedPendingUsers.splice(userIndex, 1)[0];
                 // 2. Optionally log rejection or notify user
                 console.log("Rejected:", rejectedUser);
                  approvalStatusMessage.textContent = `ปฏิเสธผู้ใช้ ${rejectedUser.username} แล้ว`;
                 approvalStatusMessage.className = 'warning'; // Use neutral/warning style maybe
                 loadPendingUsers(); // Refresh the list
             } else {
                  console.error("User not found for rejection:", userId);
                 approvalStatusMessage.textContent = `เกิดข้อผิดพลาด: ไม่พบผู้ใช้ ID ${userId}`;
                 approvalStatusMessage.className = 'error-message';
             }
              approvalStatusMessage.style.display = 'block';
        }

        // --- Admin: Template Workflow Logic (Simulated) ---

        // A.1 PDF Upload Listener
        adminPdfFile.addEventListener('change', (event) => {
             const file = event.target.files[0];
             if (file && file.type === "application/pdf") {
                 pdfUploadStatus.textContent = `ไฟล์ PDF เลือกแล้ว: ${file.name}`;
                 pdfUploadStatus.className = ''; // Clear potential error style
                 analyzePdfButton.disabled = false;
                 // Reset downstream steps
                 showWorkflowSection(adminDashboard.querySelector('#admin-pdf-upload'), 'admin');
                 currentPdfInfo = null;
                 currentAdminMapping = {};
                 adminMappingPairsDiv.innerHTML = '';
                 // etc. - handled more broadly by resetAdminWorkflow on new login/page load
             } else {
                 pdfUploadStatus.textContent = 'กรุณาเลือกไฟล์ PDF เท่านั้น';
                 pdfUploadStatus.className = 'error-message';
                 analyzePdfButton.disabled = true;
                 adminPdfFile.value = ''; // Clear invalid selection
             }
        });

        // A.2 Analyze PDF Button
        analyzePdfButton.addEventListener('click', () => {
            const file = adminPdfFile.files[0];
            if (!file) return;

            console.log("Simulating PDF Analysis for:", file.name);
            pdfUploadStatus.textContent = 'กำลังวิเคราะห์ PDF (จำลอง)...';
            analyzePdfButton.disabled = true; // Disable during analysis

            // --- Simulate Backend PDF Analysis ---
            setTimeout(() => {
                currentPdfInfo = {
                    filename: file.name,
                    // Simulate detected fields from PDF content/form fields
                    fields: ['product_name', 'sku', 'price', 'barcode_data', 'expiry_date']
                };
                console.log("Analysis complete. Detected fields:", currentPdfInfo.fields);

                pdfFilenameDisplay.textContent = currentPdfInfo.filename;
                detectedFieldsList.innerHTML = ''; // Clear previous
                currentPdfInfo.fields.forEach(field => {
                    const li = document.createElement('li');
                    li.textContent = field.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()); // Format name
                    detectedFieldsList.appendChild(li);
                });

                 pdfUploadStatus.textContent = 'วิเคราะห์ PDF สำเร็จ';
                 pdfUploadStatus.className = 'success-message';
                showWorkflowSection(adminPdfPreviewSection, 'admin'); // Show preview/analysis section
                 analyzePdfButton.disabled = false; // Re-enable button

            }, 1500); // Simulate delay
        });

         // A.3 Proceed to Mapping Button
         proceedToMappingButton.addEventListener('click', () => {
             if (!currentPdfInfo || !currentPdfInfo.fields) {
                 alert("กรุณาวิเคราะห์ไฟล์ PDF ก่อน");
                 return;
             }
             console.log("Proceeding to mapping for fields:", currentPdfInfo.fields);
             populateAdminMappingUI(currentPdfInfo.fields);
             showWorkflowSection(adminMappingSection, 'admin');
         });

         // Populate Admin Mapping UI
         function populateAdminMappingUI(pdfFields) {
             adminMappingPairsDiv.innerHTML = '';
             adminMappingError.style.display = 'none';

             // Create mapping options based on *detected PDF fields*
             pdfFields.forEach(pdfFieldId => {
                 const div = document.createElement('div');
                 div.className = 'mapping-pair';

                 const label = document.createElement('label');
                 // Display user-friendly PDF field name
                 label.textContent = `ช่อง Template (PDF): ${pdfFieldId.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}`;

                 const connectSpan = document.createElement('span');
                 connectSpan.textContent = 'รับข้อมูลจากคอลัมน์ไฟล์ Excel/CSV ชื่อ:';

                 const input = document.createElement('input');
                 input.type = 'text';
                 input.name = `map_source_for_${pdfFieldId}`;
                 input.placeholder = 'ชื่อคอลัมน์ใน Excel/CSV'; // User types the column header name
                 input.style.width = 'auto'; // Adjust style as needed
                 input.style.flexGrow = '1';

                 div.appendChild(label);
                 div.appendChild(connectSpan);
                 div.appendChild(input);
                 adminMappingPairsDiv.appendChild(div);
             });
         }

        // A.3 Handle Mapping Form Submission
        adminMappingForm.addEventListener('submit', (event) => {
            event.preventDefault();
            if (!currentPdfInfo) return; // Need PDF info

            console.log("Confirming Admin mapping...");
            adminMappingError.style.display = 'none';
            currentAdminMapping = {};
            let isValid = true;

            const formData = new FormData(adminMappingForm);
            for (const [key, value] of formData.entries()) {
                const pdfFieldId = key.replace('map_source_for_', '');
                const excelColName = value.trim(); // Get the entered Excel column name

                if (excelColName) { // Only map if a column name was entered
                    currentAdminMapping[excelColName] = pdfFieldId;
                } else {
                    // Optional: Check if required PDF fields have a mapping source
                     // if (pdfFieldId === 'product_name' || pdfFieldId === 'barcode_data') {
                     //    adminMappingError.textContent = `กรุณาระบุชื่อคอลัมน์ Excel/CSV สำหรับช่อง '${pdfFieldId}'`;
                     //    adminMappingError.style.display = 'block';
                     //    isValid = false;
                     //    break;
                    // }
                }
            }

             if (!isValid) return;

             // Check if any mapping was actually done
             if (Object.keys(currentAdminMapping).length === 0) {
                  adminMappingError.textContent = 'กรุณาระบุชื่อคอลัมน์ Excel/CSV อย่างน้อยหนึ่งคอลัมน์เพื่อทำการจับคู่';
                 adminMappingError.style.display = 'block';
                 return;
             }


            console.log("Admin Mapping Confirmed:", currentAdminMapping);
            // Proceed to allow data upload or saving template
             showWorkflowSection(adminDataUploadSection, 'admin');
             showWorkflowSection(adminPrintSettingsSection, 'admin'); // Allow setting copies/printer now
        });

        // A.4 Admin Data File Upload Listener
        adminDataFile.addEventListener('change', (event) => {
             const file = event.target.files[0];
             if (!file) {
                 adminDataUploadStatus.textContent = '';
                 adminPreviewButton.disabled = true; // Disable preview if no file
                 adminPrintButton.disabled = true;
                  showWorkflowSection(adminDataPreviewSection, 'admin'); // Hide preview table if file removed
                  showWorkflowSection(adminLabelPreviewSection, 'admin');
                  showWorkflowSection(adminPrintControlsSection, 'admin');
                 return;
             }

             if (Object.keys(currentAdminMapping).length === 0) {
                 alert("กรุณายืนยันการจับคู่ข้อมูลก่อนอัปโหลดไฟล์ข้อมูล");
                 adminDataFile.value = ''; // Clear selection
                 return;
             }

             adminDataUploadStatus.textContent = `กำลังประมวลผลข้อมูล: ${file.name}...`;
             adminPreviewButton.disabled = true; // Disable until processed
             adminPrintButton.disabled = true;

             // --- Simulate Backend Data Processing ---
             setTimeout(() => {
                 console.log("Simulating processing of admin data file:", file.name);
                 // Assume reading Excel/CSV and applying the mapping
                 // Requires mapping { 'ExcelCol': 'pdfFieldId' }
                  const excelHeaders = Object.keys(currentAdminMapping); // Headers we care about based on mapping
                  currentAdminData = [ // Sample processed data
                      { product_name: 'Admin Product A', sku: 'A-SKU001', price: '199.99', barcode_data: 'ADMIN123', expiry_date: '2024-12-31' },
                      { product_name: 'Admin Product B', sku: 'A-SKU002', price: '49.50', barcode_data: 'ADMIN456', expiry_date: '2025-06-30' }
                  ]; // Data structure uses PDF field IDs as keys

                   // Filter data to only include mapped fields + handle potential missing data
                   let displayData = currentAdminData.map(row => {
                       let filteredRow = {};
                       currentPdfInfo.fields.forEach(pdfField => {
                           filteredRow[pdfField] = row[pdfField] !== undefined ? row[pdfField] : 'N/A';
                       });
                       return filteredRow;
                   });


                 if (displayData.length > 0) {
                     populateAdminDataGrid(displayData);
                     showWorkflowSection(adminDataPreviewSection, 'admin');
                     showWorkflowSection(adminLabelPreviewSection, 'admin'); // Show preview area
                     showWorkflowSection(adminPrintControlsSection, 'admin'); // Show print buttons
                     adminPreviewButton.disabled = false; // Enable preview button
                      adminDataUploadStatus.textContent = `ประมวลผลข้อมูลจาก ${file.name} สำเร็จ`;
                      adminDataUploadStatus.className = 'success-message';
                 } else {
                      adminDataUploadStatus.textContent = `ไม่พบข้อมูลที่ตรงกับการจับคู่ในไฟล์ ${file.name}`;
                      adminDataUploadStatus.className = 'error-message';
                      showWorkflowSection(adminDataPreviewSection, 'admin'); // Hide preview table
                      showWorkflowSection(adminLabelPreviewSection, 'admin');
                      showWorkflowSection(adminPrintControlsSection, 'admin');
                 }

             }, 1500);
        });

         // A.5 Populate Admin Data Grid
         function populateAdminDataGrid(data) {
             adminDataGridHeader.innerHTML = '';
             adminDataGridBody.innerHTML = '';
             if (!data || data.length === 0 || !currentPdfInfo || !currentPdfInfo.fields) return;

             // Use PDF fields for headers
             currentPdfInfo.fields.forEach(fieldId => {
                 const th = document.createElement('th');
                 th.textContent = fieldId.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                 adminDataGridHeader.appendChild(th);
             });

             // Create Rows
             data.forEach(row => {
                 const tr = document.createElement('tr');
                 currentPdfInfo.fields.forEach(fieldId => {
                     const td = document.createElement('td');
                     td.textContent = row[fieldId] !== undefined ? row[fieldId] : '';
                     tr.appendChild(td);
                 });
                 adminDataGridBody.appendChild(tr);
             });
         }

        // A.6 Save Template Button
        saveTemplateButton.addEventListener('click', () => {
             const templateName = adminTemplateNameInput.value.trim();
             if (!templateName) {
                 alert("กรุณาตั้งชื่อ Template ก่อนบันทึก");
                 return;
             }
             if (Object.keys(currentAdminMapping).length === 0 || !currentPdfInfo) {
                  alert("กรุณาอัปโหลด PDF และยืนยันการจับคู่ข้อมูลก่อนบันทึก Template");
                  return;
             }

             console.log("Simulating saving template:", templateName);
             // --- Simulate Backend Save ---
             // Send templateName, currentPdfInfo.filename (or ID), currentAdminMapping to backend
              setTimeout(() => {
                  alert(`Template '${templateName}' บันทึกสำเร็จแล้ว (จำลอง)`);
                 // Optionally clear the name or disable button after save?
             }, 500);
        });


        // A.7 Admin Preview Button
        adminPreviewButton.addEventListener('click', () => {
            if (currentAdminData.length === 0) {
                alert('กรุณาอัปโหลดและประมวลผลไฟล์ข้อมูลก่อนแสดงตัวอย่าง');
                return;
            }
            console.log('Admin generating preview...');
            adminPreviewArea.innerHTML = '<p>กำลังสร้างตัวอย่าง...</p>';
            adminPrintStatus.textContent = '';
            adminPrintButton.disabled = true;

            // --- Simulate Backend Preview Generation ---
            setTimeout(() => {
                adminPreviewArea.innerHTML = ''; // Clear loading
                currentAdminData.slice(0, 3).forEach((dataItem, index) => {
                    const img = document.createElement('img');
                    img.src = `https://via.placeholder.com/250x150.png?text=Admin+Label+${index+1}+(${dataItem.product_name || 'Data'})`;
                    img.alt = `ตัวอย่าง Admin ฉลาก ${index + 1}`;
                    adminPreviewArea.appendChild(img);
                });
                if (currentAdminData.length > 3) {
                     const p = document.createElement('p');
                     p.textContent = `(และอีก ${currentAdminData.length - 3} รายการ...)`;
                     adminPreviewArea.appendChild(p);
                 }
                adminPrintButton.disabled = false; // Enable print button
            }, 1000);
        });

        // A.8 Admin Print Button
        adminPrintButton.addEventListener('click', () => {
             const copies = adminPrintCopiesInput.value;
             const selectedPrinter = adminPrinterSelect.value;

             if (currentAdminData.length === 0) {
                 alert('ไม่มีข้อมูลสำหรับพิมพ์');
                 return;
             }
             console.log(`Admin printing ${currentAdminData.length} items, ${copies} copies each to ${selectedPrinter}.`);
             adminPrintStatus.textContent = 'กำลังส่งข้อมูลพิมพ์ (จำลอง)...';
             adminPrintButton.disabled = true;
             adminPreviewButton.disabled = true; // Disable preview during print

             // --- Simulate Backend Print Job ---
             setTimeout(() => {
                 adminPrintStatus.textContent = `พิมพ์ฉลาก ${currentAdminData.length} รายการ (${copies} สำเนา) สำเร็จ (จำลอง) ไปยัง ${selectedPrinter}`;
                 adminPrintStatus.className = 'success-message';
                 console.log('Admin Print job supposedly completed.');
                  // Keep buttons disabled or re-enable? Maybe keep disabled until new data/preview.
             }, 2000);
        });


        // --- User: Request Label Logic ---
        userRequestForm.addEventListener('submit', (event) => {
             event.preventDefault();
             const file = userDataFile.files[0];
             const deliveryDate = userDeliveryDate.value;
             userRequestStatus.textContent = '';
             userRequestStatus.className = ''; // Clear previous style

             if (!file || !deliveryDate) {
                 userRequestStatus.textContent = 'กรุณาเลือกไฟล์ข้อมูลและวันที่ต้องการรับฉลาก';
                 userRequestStatus.className = 'error-message';
                 return;
             }

             console.log(`User submitting request: File: ${file.name}, Delivery Date: ${deliveryDate}`);
             userRequestStatus.textContent = 'กำลังส่งคำขอ...';

             // --- Simulate Backend Request Submission ---
             setTimeout(() => {
                  const newJob = {
                     id: 'job' + Date.now(),
                     userId: currentUser.username,
                     filename: file.name,
                     requestDate: new Date(),
                     deliveryDate: new Date(deliveryDate),
                     status: 'received' // Initial status
                  };
                  simulatedUserPrintJobs.push(newJob);
                  console.log("New job added:", newJob);

                  userRequestStatus.textContent = `ส่งคำขอพิมพ์ฉลากสำหรับไฟล์ ${file.name} สำเร็จแล้ว กรุณาตรวจสอบสถานะ`;
                  userRequestStatus.className = 'success-message';
                  userRequestForm.reset(); // Clear the form
                  loadUserPrintJobs(); // Refresh the status list immediately
             }, 1000);
        });

        // --- User: Status Check Logic ---
        function loadUserPrintJobs() {
            if (!currentUser || currentUser.role !== 'user') return; // Only for logged in users

            console.log("Loading print jobs for user:", currentUser.username);
            userJobsTbody.innerHTML = ''; // Clear existing rows
            userStatusMessage.textContent = '';

             // Filter jobs belonging to the current user
            const userJobs = simulatedUserPrintJobs.filter(job => job.userId === currentUser.username);

            if (userJobs.length === 0) {
                userJobsTbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">คุณยังไม่มีคำขอพิมพ์ฉลาก</td></tr>';
                return;
            }

            userJobs.sort((a, b) => b.requestDate - a.requestDate); // Show newest first

            userJobs.forEach(job => {
                const row = userJobsTbody.insertRow();
                const statusText = statusMap[job.status] || job.status;
                 const statusClass = statusClassMap[job.status] || 'status-received'; // Default badge style

                 // Check if the "Mark Received" button should be shown
                 const canMarkReceived = job.status === 'ready'; // Only show if status is 'พร้อมส่งมอบ'

                row.innerHTML = `
                    <td>${job.id}</td>
                    <td>${job.filename}</td>
                    <td>${job.deliveryDate.toLocaleDateString('th-TH')}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        ${canMarkReceived ? `<button class="success" onclick="markJobReceived('${job.id}')">กดรับฉลาก</button>` : '-'}
                    </td>
                `;
            });
        }

        function markJobReceived(jobId) {
            console.log(`User marking job ${jobId} as received`);
            userStatusMessage.textContent = ''; // Clear previous message

            // --- Simulate Backend Update ---
            const jobIndex = simulatedUserPrintJobs.findIndex(j => j.id === jobId && j.userId === currentUser.username);
            if (jobIndex > -1 && simulatedUserPrintJobs[jobIndex].status === 'ready') {
                simulatedUserPrintJobs[jobIndex].status = 'delivered'; // Update status
                console.log("Job status updated to delivered:", jobId);
                userStatusMessage.textContent = `ยืนยันการรับฉลากสำหรับ ID ${jobId} สำเร็จแล้ว`;
                userStatusMessage.className = 'success-message';
                loadUserPrintJobs(); // Refresh the list to update status and remove button
            } else {
                 console.error("Job not found or not ready to be marked as received:", jobId);
                  userStatusMessage.textContent = `เกิดข้อผิดพลาด: ไม่สามารถยืนยันการรับฉลากสำหรับ ID ${jobId} ได้ในขณะนี้`;
                  userStatusMessage.className = 'error-message';
            }
        }


        // --- Initial Load Check ---
        window.addEventListener('load', () => {
             const storedUser = localStorage.getItem('loggedInUser');
             if (storedUser) {
                 try {
                     currentUser = JSON.parse(storedUser);
                     if (currentUser && currentUser.username && currentUser.role) {
                         console.log('User session found:', currentUser);
                         welcomeMessage.textContent = `ยินดีต้อนรับ, ${currentUser.username}! (${currentUser.role})`;
                         loggedInUserSpan.textContent = currentUser.username;
                         showScreen(appScreen);
                         showDashboard(currentUser.role);
                     } else {
                          // Invalid data in storage
                         currentUser = null;
                         localStorage.removeItem('loggedInUser');
                          showScreen(loginScreen);
                     }
                 } catch (e) {
                     console.error("Error parsing stored user data", e);
                     currentUser = null;
                     localStorage.removeItem('loggedInUser');
                     showScreen(loginScreen);
                 }
             } else {
                 console.log('No active session found.');
                 showScreen(loginScreen);
             }
         });

    </script>

</body>
</html>